extends ./layout.pug
block container
  section.content-header
    h1
      | Administración de Clientes PARM
    ol.breadcrumb
      li
        i.fa.fa-building
        |  Clientes PARM
  section.content
    .nav-tabs-custom
      ul.nav.nav-tabs
        li.active
          a(href='#tab_1', data-toggle='tab') Solicitudes Pendientes
        li
          a(href='#tab_2', data-toggle='tab') Clientes PARM
      .tab-content
        #tab_1.tab-pane.active
          #toolbarsolicitudespendientes
            .form-inline
              button#confirmar.btn.btn-success
                i.glyphicon.glyphicon-ok
                |  Confirmar Cuenta
              |  
              span Paquete PARM 
              select#paquete.form-control
                option(value='PPF01') PPF01 - Paquete Fijo 1
                option(value='PPF02') PPF02 - Paquete Fijo 2
                option(value='PPF03') PPF03 - Paquete Fijo 3
                option(value='PPF04') PPF04 - Paquete Fijo 4
              |  
              button#asignar_paquete.btn.btn-success
                i.glyphicon.glyphicon-briefcase
                |  Asignar Paquete
          table#tbl_solicitudespendientes.table.table-hover(data-toggle='table', data-url='/parmsecure/admin/listarsolicitudespendientes', data-toolbar='#toolbarsolicitudespendientes',data-show-refresh="true",data-id-field='RUC',data-checkbox-header='false')
            thead
              tr
                th(data-field='ID',data-checkbox='true',data-align='center')
                th(data-field='RUC') RUC
                th(data-field='RAZON_SOCIAL') RAZON SOCIAL
                th(data-field='CORREO') CORREO
                th(data-field='TELEFONO') TELEFONO
                th(data-field='PAQUETE') PAQUETE
                th(data-field='ESTADO',data-formatter='formateadorEstado') ESTADO
                
        #tab_2.tab-pane
          #toolbarclientes
            .form-inline
              button#bloquear_cliente.btn.btn-danger
                i.icon.fa.fa-lock 
                |  Bloquear Cliente
              |  
              button#desbloquear_cliente.btn.btn-success
                i.icon.fa.fa-unlock 
                |  Desbloquear Cliente
          table#tbl_clientes.table.table-hover(data-toggle='table', data-url='/parmsecure/admin/listarclientes', data-toolbar='#toolbarclientes',data-show-refresh="true",data-id-field='RUC',data-checkbox-header='false',data-search='true')
            thead
              tr
                th(data-field='ID',data-checkbox='true',data-align='center')
                th(data-field='RUC') RUC
                th(data-field='RAZON_SOCIAL') RAZON SOCIAL
                th(data-field='DIRECCION') CORREO
                th(data-field='TELEFONO') TELEFONO
                th(data-field='CORREO') CORREO
                th(data-field='PAQUETE') PAQUETE
                th(data-field='ESTADO',data-formatter='formateadorEstado') ESTADO

    #mensaje_modal.modal.fade(tabindex='-1', role='dialog')
      .modal-dialog(role='document')
        .modal-content
          .modal-header
            button.close(type='button', data-dismiss='modal', aria-label='Close')
              span(aria-hidden='true') &times;
            h4.modal-title Mensaje
          .modal-body
            p#mensaje
          .modal-footer
            button.btn.btn-default(type='button', data-dismiss='modal') Cerrar
  script.
    $(document).ready(function(){

      $('#confirmar').click(function (event) {
        var ids = getIdSolicitudesSelections();
        var continuar = true;
        var mensaje;
        if (ids.length == 0) {
          continuar = false;
          mensaje = "No hay solicitudes seleccionadas.";
        } else {
          $.each(ids, function(index, value){
            if(value.paquete == null) {
              continuar = false;
              mensaje = "Existe al menos un cliente que no tiene asociado un paquete, tiene que asignar un paquete antes de confirmar la cuenta.";
            }
          });
        }
        
        if(continuar) {
          $.ajax({
            type:'GET',
            url:'/parmsecure/admin/confirmarsolicitud',
            data:{seleccion:ids},
            contentType:'application/json',
            success:function(data,textStatus,jqXHR){
              $('#tbl_solicitudespendientes').bootstrapTable('refresh');
            },
            error:function(jqXHR,textStatus,errorThrown){
              console.log(errorThrown);
              $("#mensaje").text("Hubo un error en el servidor al confirmar la(s) solicitud(es), por favor contactar con el administrador de la plataforma.");
              $("#mensaje_modal").modal("show");
            }
          });
        } else {
          $("#mensaje").text(mensaje);
          $("#mensaje_modal").modal("show");
        }
        event.preventDefault();
      });

      $('#asignar_paquete').click(function (event) {
          var paquete = $("#paquete").val();
          asignarPaquete(paquete);
      });

      $('#bloquear_cliente').click(function(event){
        var clientes = getClientesSeleccionados();
        var continuar = true;
        var mensaje;
        if (clientes.length == 0) {
          continuar = false;
          mensaje = "No hay clientes seleccionados.";
        } else {
          //Validando que todos los clientes seleccionados estén activos
          $.each(clientes, function(index, value){
            if(value.estado != 3) {
              continuar = false;
              mensaje = "Por favor seleccione solo clientes cuyo ESTADO sea \"Activo\".";
            }
          });
        }
        if(continuar) {
          $.ajax({
            type:'GET',
            url:'/parmsecure/admin/bloquearcliente',
            data:{clientes:clientes},
            contentType: 'application/json',
            success:function(data,textStatus,jqXHR){
              $('#tbl_clientes').bootstrapTable('refresh');
            },
            error:function(jqXHR,textStatus,errorThrown){
              console.log(errorThrown);
              $("#mensaje").text("Hubo un error en el servidor al bloquear cliente(s), por favor contactar con el administrador de la plataforma.");
              $("#mensaje_modal").modal("show");
            }
          });
        } else {
          $("#mensaje").text(mensaje);
          $("#mensaje_modal").modal("show");
        }
      });

      $('#desbloquear_cliente').click(function(event){
        var clientes = getClientesSeleccionados();
        var continuar = true;
        var mensaje;
        if (clientes.length == 0) {
          continuar = false;
          mensaje = "No hay clientes seleccionados.";
        } else {
          //Validando que todos los clientes seleccionados estén activos
          $.each(clientes, function(index, value){
            if(value.estado != 4) {
              continuar = false;
              mensaje = "Por favor seleccione solo clientes cuyo ESTADO sea \"Bloqueado\".";
            }
          });
        }
        if(continuar) {
          $.ajax({
            type:'GET',
            url:'/parmsecure/admin/desbloquearcliente',
            data:{clientes:clientes},
            contentType: 'application/json',
            success:function(data,textStatus,jqXHR){
              $('#tbl_clientes').bootstrapTable('refresh');
            },
            error:function(jqXHR,textStatus,errorThrown){
              console.log(errorThrown);
              $("#mensaje").text("Hubo un error en el servidor al bloquear cliente(s), por favor contactar con el administrador de la plataforma.");
              $("#mensaje_modal").modal("show");
            }
          });
        } else {
          $("#mensaje").text(mensaje);
          $("#mensaje_modal").modal("show");
        }
      });
    });

    var checkedRows = [];

    $('#tbl_solicitudespendientes').on('check.bs.table', function (table, row, element) {
      var index = element.attr('data-index');
      checkedRows.push(index);
    });

    $('#tbl_solicitudespendientes').on('uncheck.bs.table', function (table, row, element) {
      var index = element.attr('data-index');
      $.each(checkedRows, function(i, value) {
        if (value === index) {
          checkedRows.splice(i,1);
        }
      });
    });

    function getIdSolicitudesSelections() {
      return $.map($('#tbl_solicitudespendientes').bootstrapTable('getSelections'), function (row) {
        return {ruc:row.RUC,correo:row.CORREO,paquete:row.PAQUETE};
      });
    }

    function getClientesSeleccionados() {
      return $.map($('#tbl_clientes').bootstrapTable('getSelections'), function (row) {
        return {ruc:row.RUC,estado:row.ESTADO};
      });
    }

    function asignarPaquete(paquete) {
      $.each(checkedRows, function(i, value) {
        $('#tbl_solicitudespendientes').bootstrapTable('updateRow',{index:value,row:{PAQUETE:paquete}});
      });
    }

    function formateadorEstado(value, row, index) {
      if(value == '1') {
        return "<span class='label label-warning'>PENDIENTE</span>";
      } else if(value == '2'){
        return "<span class='label label-info'>CODIGO ENVIADO</span>";
      } else if(value == '3'){
        return "<span class='label label-success'>ACTIVO</span>";
      } else {
        return "<span class='label label-danger'>BLOQUEADO</span>";
      }
    }


